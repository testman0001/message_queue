# 消息队列横向对比

消息队列关键的评价指标：

1.吞吐量（QPS），分为读、写速率，和消息大小、带宽有关，并且读速率受到消费者消费能力影响。也有使用MB/s作为评价吞吐的方式。

2.时延

3.可靠性

4.其它功能

## 1.吞吐量

rabbitmq，一般单机万级，本地机器性能较好可达十多万，集群场景能进一步提升吞吐，个人测试单机、双节点、三节点的吞吐比为1:1.55:2.12

kafka，单机能到十万级，集群场景能到百万

nsq，官方文档测试单机十万级，集群百万级，实际能否达到存疑

**从性能上来说，单机并没有太大差距，如果要追求最大吞吐，主流观点是选择kafka**

## 2.时延

这个其实区别不大，本地单机内存队列传输基本都是微秒级别，跨机器传输受到网络延迟影响为毫秒级，**如果非要从消息延迟出发，一般来说选择rabbitmq**

## 3.可靠性

这里分几个方面讨论

### 3.1 副本和灾备恢复

rabbitmq支持集群模式部署，可通过durable+mirror属性让队列在所有节点上创建副本，从而让消息同时存在多个节点上，节点故障后能做到快速切换且不丢失消息

kafka，每个partition有多个副本，每个副本日志独立保存，leader失效后也能重新选取进行恢复

nsq，没有备份策略，故障后消息彻底丢失

**如果不能容忍消息丢失，不要使用nsq，或者使用nsq的改进版本**

### 3.2 一次性处理语义

一次性处理语义具体分成两部分，精确一次投递，精确一次消费

rabbitmq，通过publisher confirm机制，消息在确实投到队列后返回ack给生产者，没收到或者收到nack则重投，因此能实现“至少一次投递”；同理消费者通过ack，也能实现“至少一次消费”，客户端侧需要自己根据id来去重以实现“精确一次消费”

而kafka不仅消息投递时能通过ack实现“至少一次投递”，同时引入消息id来实现“精确一次投递”；同样，消费者通过手动提交offset及使用消息id标记来去重，可实现“精确一次消费”

 nsq没有上述id机制，消息投到nsqd可能重复多次，因此只能实现“至少一次投递”；从nsqd到消费者有ack机制能“至少一次消费”，消费者必须自己进行去重处理来实现“精确一次消费。由于broker存在崩溃后消息丢失问题，严格意义上至少一次语义无法等到保证

**综上所述，如果重视一次性处理语义，那么建议选择kafka**

### 3.3 是否支持顺序消费

消息顺序问题也是常常关注的点，因为乱序的消息会导致不同的最终状态，要保证消息的顺序（这里的顺序消费指从生产者到消费者最终是否次序一致），同样要从两个阶段分析，投递阶段和消费阶段

rabbitmq投递阶段无法保证顺序到达server，仅能在消费阶段通过prefetch count=1来一次消费一条消息保证消费有序。如果要支持顺序消费，需要客户端侧自己处理，通过id进行辨识，消费者侧让消息id不对的重新入队，下次再消费

kafka新版本在发送端引入了幂等特性，以<pid, partition>-消息id来为每个生产者在分区投递的消息分配唯一标识，该标识使得生产者写入的消息id只能是递增，小于id的会被禁止写入，因此能保证生产者的顺序性（也可以通过设置ack>0及单个连接正在处理消息数为1来保证）；消费时消费者在提交偏移前不会拉取后续消息，对于同Topic同Partition的消息可保证顺序消费。因此顺序消费的前提是限制topic下partition数目为1或者producer侧指定消息落到特定partition，但是因此丧失重要的并发消费特性

nsq同样不支持生产者投递消息的幂等性，投递顺序也无法保证；另外因为nsqd之间的独立性，两个nsqd上同一个topic+channel被一个消费者同时消费时，顺序也不一定和投递一致，无法做到topic级别的顺序消费。

**如果对顺序消费有要求，kafka更合适**

## 4.其它功能

|                                                | rabbitmq      | kafka | nsq             |
| ---------------------------------------------- | ------------- | ----- | --------------- |
| 历史消息消费                                   | no            | yes   | no              |
| 死信队列（消息过期、被拒绝、队列长度达到限制） | yes           | no    | no              |
| 延迟队列                                       | yes(通过插件) | no    | yes(pub defer) |
